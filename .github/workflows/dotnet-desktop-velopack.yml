name: Build and Release

on:
  push:
    branches: [ "master" ]  # Change to your default branch if different
    
jobs:  
  build-and-release:
      runs-on: windows-latest  
      permissions:
        contents: write  # Allows creating releases
      
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v6
    
        - name: Get Version from Project File
          id: get_version
          shell: bash
          run: echo "version=$(grep -oE '<Version>[^<]+' PrevisionalAccountManager/PrevisionalAccountManager.csproj | sed 's/<Version>//')" >> $GITHUB_OUTPUT
  
        - name: Check if version changed
          id: check_change
          shell: pwsh
          run: |
            $headers = @{
              Authorization = "token ${{ github.token }}"
              Accept = "application/vnd.github.v3+json"
            }    
            $response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/tags" -Headers $headers
            $currentVersion = "${{ steps.get_version.outputs.version }}"
            
            if ($response.Count -gt 0) {
              $previousVersion = $response[0].name.TrimStart('v')
            } else {
              $previousVersion = "0.0.0"
            }    
            if ( $currentVersion -ne $previousVersion) {
              $version_changed = 'true'
              echo "version_changed=true" >> $env:GITHUB_OUTPUT
            } else {
              $version_changed = 'false'
              echo "version_changed=false" >> $env:GITHUB_OUTPUT
            }
            echo "Current version: $version_changed ( $previousVersion -> $currentVersion )"
 
        - name: Install .NET
          if: steps.check_change.outputs.version_changed == 'true'
          uses: actions/setup-dotnet@v5
          with:
           dotnet-version: | 
            9.0.x
            10.0.x
      
        - name: Restore dependencies Build Publish
          if: steps.check_change.outputs.version_changed == 'true'
          run: dotnet publish --configuration Release
      
        - name: Create Velopack Release
          if: steps.check_change.outputs.version_changed == 'true'
          run: |
            VERSION= ${{ steps.get_version.outputs.version }}
            dotnet tool install -g vpk
            vpk download github --repoUrl https://github.com/${{ github.repository }}
            vpk pack --packId PrevisionalAccountManager --packDir PrevisionalAccountManager/Publish --mainExe PrevisionalAccountManager.exe --noPortable --skipVeloAppCheck -v $VERSION
            vpk upload github --repoUrl https://github.com/${{ github.repository }} --publish --releaseName "PrevisionalAccountManager $VERSION" --tag v$VERSION --token ${{ secrets.GITHUB_TOKEN }}
